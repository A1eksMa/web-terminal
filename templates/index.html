<!doctype html>
<html>
  <head>
    <title>Web Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #000;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
    </style>
  </head>
  <body>
    <div id="terminal"></div>
    <script>
      console.log("Script start.");

      const term = new Terminal({
          cursorBlink: true,
          rows: 40,
          cols: 120,
      });
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById('terminal'));
      fitAddon.fit();
      console.log("Terminal initialized.");

      const protocol = (location.protocol === 'https:') ? 'wss://' : 'ws://';
      const socketURL = protocol + location.hostname + ((location.port) ? (':' + location.port) : '') + '/ws';
      console.log("Attempting to connect to WebSocket at:", socketURL);

      try {
        const socket = new WebSocket(socketURL);

        socket.onopen = (ev) => {
          console.log("SUCCESS: WebSocket connection opened.", ev);
          term.write('\r\n[CONNECTION ESTABLISHED]\r\n\r\n');
          
          // Manual wiring: terminal input -> websocket
          term.onData(data => {
            socket.send(data);
          });

          // Manual wiring: websocket -> terminal output
          socket.onmessage = (event) => {
            term.write(event.data);
          };
        };

        socket.onclose = (ev) => {
          console.error("EVENT: WebSocket connection closed.", ev);
          term.write(`\r\n\r\n[CONNECTION CLOSED: Code ${ev.code}, Reason: ${ev.reason}]\r\n`);
        };

        socket.onerror = (ev) => {
          console.error("ERROR: WebSocket error.", ev);
        };

      } catch (e) {
        console.error("FATAL: Failed to create WebSocket.", e);
      }

      window.addEventListener('resize', () => {
        fitAddon.fit();
      });

      console.log("Script end.");
    </script>
  </body>
</html>